{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>YSAutoML Total Pipeline</title>
  <style>
    body { margin:0; font-family:Inter, sans-serif; background:#1B1B1B; color:#FAF1E4; display:flex; }

    /* Sidebar */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      overflow-y: auto;
      width: 250px;
      background: #111;
      padding: 20px;
      z-index: 1000; /* ‚úÖ Í≤πÏπ† Îïå ÏúÑÏóê Ïò§ÏßÄ ÏïäÎèÑÎ°ù Î™ÖÏãú */
    }

    .content {
      flex: 1;
      padding: 20px;
      margin-left: 300px; /* ‚úÖ sidebarÎßåÌÅº Ïò§Î•∏Ï™ΩÏúºÎ°ú Î∞ÄÍ∏∞ */
      box-sizing: border-box;
      min-width: calc(100% - 300px); /* ‚úÖ ÏΩòÌÖêÏ∏†Í∞Ä ÏûòÎ¶¨ÏßÄ ÏïäÍ≤å */
    }

    .sidebar h1 { font-size:22px; margin-bottom:5px; }
    .sidebar p { font-size:12px; color:#aaa; margin-bottom:30px; }
    .menu-item { padding:10px 15px; cursor:pointer; border-radius:6px; transition:background 0.2s; margin-bottom:5px; }
    .menu-item:hover { background:#1F1F1F; }
    .menu-item.active { background:#1F53FF; color:white; }

    .logo-link { color:#FAF1E4; text-decoration:none; cursor:pointer; }
    .logo-link:hover { color:#FAF1E4; }

    /* Content */
    /* .content { flex:1; padding:20px; } */
    .topbar { display:flex; justify-content:flex-end; align-items:center; gap:10px; margin-bottom:15px; }
    .btn-train { background:#1F53FF; border:none; padding:10px 20px; color:#fff; border-radius:6px; cursor:pointer; }
    .btn-stop { background:#d32f2f; border:none; padding:10px 20px; color:#fff; border-radius:6px; cursor:pointer; }

    /* Form layout */
    .form-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:16px; }
    .form-card { background:#1F1F1F; padding:16px; border-radius:10px; box-shadow:0 0 6px rgba(0,0,0,0.3); }
    .form-card h3 { font-size:14px; font-weight:600; margin-bottom:10px; color:#EAEAEA; }
    .form-card select, .form-card input { width:100%; padding:10px; background:#262626; border:1px solid #333; border-radius:6px; color:#FAF1E4; font-size:14px; }

    .radio-group, .checkbox-group { display:flex; flex-direction:column; gap:6px; width:100%; }
    .radio-group label, .checkbox-group label { display:flex; align-items:center; white-space:nowrap; gap:10px; }
    .radio-group label span, .checkbox-group label span { display:inline-block; min-width:100px; }
    .radio-group input, .checkbox-group input { margin-left:auto; accent-color:#1F53FF; }

    label { font-size:14px; cursor:pointer; }

    /* ‚úÖ Log & Result */
    .logbox {
      background:#000;
      color:#0f0;
      font-family:monospace;
      height:220px;
      overflow-y:scroll;
      margin-top:20px;
      padding:10px;
      border-radius:8px;
      white-space: pre-wrap;  /* ‚úÖ Ï§ÑÎ∞îÍøà Î∞òÏòÅ */
      line-height: 1.4;
    }

    table { width:100%; border-collapse:collapse; margin-top:20px; background:#262626; border-radius:8px; overflow:hidden; }
    th, td { padding:10px; border-bottom:1px solid #333; text-align:left; }
    th { background:#333; }

    .btn-small {
      background:#333;
      border:none;
      padding:6px 10px;
      border-radius:6px;
      color:#FAF1E4;
      cursor:pointer;
      font-size:13px;
    }
    .btn-small:hover { background:#1F53FF; color:#fff; }

  </style>
  <!-- ‚úÖ CSRF ÌÜ†ÌÅ∞ÏùÑ Í∞ÄÏ†∏Ïò§Îäî Ïú†Ìã∏ Ìï®Ïàò Ï∂îÍ∞Ä -->
  <script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // ‚úÖ Ï†ÑÏó≠ Î≥ÄÏàòÎ°ú CSRF ÌÜ†ÌÅ∞ Ï†ÄÏû•
    const csrftoken = getCookie('csrftoken');
  </script>
</head>
<body>

  <!-- Sidebar -->
  <div class="sidebar">
    <h1><a href="/" class="logo-link">YSAutoML</a></h1>
    <p>Total Model Pipeline</p>
    <div class="menu">
      <div class="menu-item active" id="total-menu">Total</div>
    </div>
  </div>

  <!-- Content -->
  <div class="content">
    <div class="topbar">
      <button class="btn-train" id="runBtn">Run Total Pipeline</button>
      <button class="btn-stop" id="stopBtn">Stop Process</button>
    </div>

    <form id="totalForm" class="form-grid">
      <!-- Model -->
      <div class="form-card">
        <h3>Model</h3>
        <select name="model">
          <option value="AutoFormer">AutoFormer</option>
          <option value="ResNet18">ResNet18</option>
          <option value="MobileNetV2">MobileNetV2</option>
        </select>
      </div>

      <!-- Config -->
      <div class="form-card">
        <h3>Config</h3>
        <label>Epochs <input type="number" name="epochs" value="50"></label>
        <label>Learning Rate <input type="number" step="0.0001" name="lr" value="0.001"></label>
        <label>Seed <input type="number" name="seed" value="42"></label>
        <label>Device <input type="text" name="device" value="cuda:0"></label>
      </div>

      <!-- Data -->
      <div class="form-card">
        <h3>Data (multiple allowed)</h3>
        <div class="checkbox-group">
          <label><span>FYI</span><input type="checkbox" name="data" value="fyi"></label>
          <label><span>DSBN</span><input type="checkbox" name="data" value="dsbn"></label>
        </div>
      </div>

      <!-- Network -->
      <div class="form-card">
        <h3>Network (select one)</h3>
        <div class="radio-group">
          <label><span>Few-shot</span><input type="radio" name="network" value="fewshot" checked></label>
          <label><span>One-shot</span><input type="radio" name="network" value="oneshot"></label>
          <label><span>Zero-shot</span><input type="radio" name="network" value="zeroshot"></label>
        </div>
      </div>

      <!-- NAS Config (Zero-shot only) -->
      <div class="form-card" id="nasConfigBox" style="display:none;">
        <h3>NAS Config</h3>

        <!-- GPU & SEED -->
        <label>GPU ID <input type="number" name="gpu" value="0" /></label>
        <label>Seed <input type="number" name="seed" value="123" /></label>

        <!-- Metric -->
        <label>Metric
          <select name="metric">
            <option value="AZ_NAS">AZ_NAS</option>
            <option value="SynFlow">SynFlow</option>
            <option value="GradNorm">GradNorm</option>
          </select>
        </label>

        <!-- Population & Iteration -->
        <label>Population Size <input type="number" name="population_size" value="100" /></label>
        <label>Evolution Max Iter <input type="number" name="evolution_max_iter" value="100" /></label>

        <!-- Resolution -->
        <label>Resolution <input type="number" name="resolution" value="224" /></label>

        <!-- Budget FLOPs -->
        <label>Budget FLOPs (√ó1e6):</label>
        <input type="range" id="flopsSlider" min="50" max="1000" step="50" value="1000" />
        <p id="flopsValue" style="margin-top:8px;">Current: 1000e6</p>

        <div style="display:flex; gap:8px; margin-top:10px;">
          <button type="button" class="btn-small" id="flopsSmall">Small (450e6)</button>
          <button type="button" class="btn-small" id="flopsMedium">Medium (600e6)</button>
          <button type="button" class="btn-small" id="flopsLarge">Large (1000e6)</button>
        </div>
        <input type="hidden" name="budget_flops" id="budgetFlopsHidden" value="1000e6" />

        <!-- Max Layers / Batch Size -->
        <label>Max Layers <input type="number" name="max_layers" value="16" /></label>
        <label>Batch Size <input type="number" name="batch_size" value="32" /></label>

        <!-- Data Path -->
        <label>Data Path <input type="text" name="data_path" value="/dataset/ILSVRC2012/" /></label>
      </div>



      <!-- Optimization -->
      <div class="form-card">
        <h3>Optimization (select one)</h3>
        <div class="radio-group">
          <label><span>FXP</span><input type="radio" name="optimization" value="fxp" checked></label>
          <label><span>Loss Search</span><input type="radio" name="optimization" value="losssearch"></label>
          <label><span>MTL</span><input type="radio" name="optimization" value="mtl"></label>
        </div>
      </div>
    </form>

    <div class="logbox" id="logBox"></div>

    <table id="resultTable" style="display:none;">
      <thead><tr><th>Stage</th><th>Status</th><th>Log / Checkpoint</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const runBtn = document.getElementById("runBtn");
    const stopBtn = document.getElementById("stopBtn");
    const logBox = document.getElementById("logBox");
    const resultTable = document.getElementById("resultTable");
    const resultBody = resultTable.querySelector("tbody");
    const form = document.getElementById("totalForm");

    // === NAS CONFIG Logic ===
    const nasBox = document.getElementById("nasConfigBox");
    const flopsSlider = document.getElementById("flopsSlider");
    const flopsValue = document.getElementById("flopsValue");
    const flopsHidden = document.getElementById("budgetFlopsHidden");

    const flopsSmall = document.getElementById("flopsSmall");
    const flopsMedium = document.getElementById("flopsMedium");
    const flopsLarge = document.getElementById("flopsLarge");

    // ‚ë† Network ÏÑ†ÌÉù Î≥ÄÌôî Í∞êÏßÄ ‚Üí Zero-shot Ïãú NAS Config ÌëúÏãú
    const networkRadios = document.querySelectorAll("input[name='network']");
    networkRadios.forEach(radio => {
      radio.addEventListener("change", () => {
        if (radio.value === "zeroshot" && radio.checked) {
          nasBox.style.display = "block";
        } else if (radio.checked) {
          nasBox.style.display = "none";
        }
      });
    });

    // ‚ë° Ïä¨ÎùºÏù¥Îçî Í∞í ÏóÖÎç∞Ïù¥Ìä∏
    flopsSlider.addEventListener("input", () => {
      const val = flopsSlider.value;
      flopsValue.textContent = `Current: ${val}e6`;
      flopsHidden.value = `${val}e6`;
    });

    // ‚ë¢ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú Ïä¨ÎùºÏù¥Îçî Ïù¥Îèô
    flopsSmall.onclick = () => {
      flopsSlider.value = 450;
      flopsValue.textContent = "Current: 450e6";
      flopsHidden.value = "450e6";
    };
    flopsMedium.onclick = () => {
      flopsSlider.value = 600;
      flopsValue.textContent = "Current: 600e6";
      flopsHidden.value = "600e6";
    };
    flopsLarge.onclick = () => {
      flopsSlider.value = 1000;
      flopsValue.textContent = "Current: 1000e6";
      flopsHidden.value = "1000e6";
    };


    let isRunning = false;
    let stopRequested = false;

    // runBtn.onclick = async () => {
    //   if (isRunning) return;
    //   isRunning = true;
    //   stopRequested = false;

    //   // ‚úÖ Î°úÍ∑∏ ÏôÑÏ†Ñ Ï¥àÍ∏∞Ìôî
    //   logBox.innerHTML = "";
    //   resultTable.style.display = "none";
    //   resultBody.innerHTML = "";

    //   logLine("üöÄ Running YSAutoML Total Pipeline...");

    //   const formData = new FormData(form);
    //   const selectedData = formData.getAll("data");
    //   const network = formData.get("network");
    //   const optimization = formData.get("optimization");
    //   const model = formData.get("model");

    //   // Stage 1
    //   if (await stageCheck(`[Stage 1] Running ${network} search for ${model}...`, 2000)) return;
    //   addRow("Network Search", "Done", `ckpt_best_${network}.pth`);

    //   // Stage 2
    //   for (const d of selectedData) {
    //     if (await stageCheck(`[Stage 2] Applying Data Method: ${d.toUpperCase()}...`, 1500)) return;
    //     addRow(`Data: ${d.toUpperCase()}`, "Applied", `processed_${d}.json`);
    //   }

    //   // Stage 3
    //   if (await stageCheck(`[Stage 3] Running ${optimization} optimization...`, 2500)) return;
    //   addRow("Optimization", "Done", `final_${optimization}.pth`);

    //   logLine(`‚úÖ Total Pipeline Finished Successfully.`);
    //   resultTable.style.display = "table";
    //   isRunning = false;
    // };
    runBtn.onclick = async () => {
      logBox.innerHTML = "üöÄ Running YSAutoML Total Pipeline...\n";
      resultTable.style.display = "none";
      resultBody.innerHTML = "";

      const formData = new FormData(form);
      const body = {};
      formData.forEach((v, k) => (body[k] = v));

      const response = await fetch("/run_total_pipeline/", {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-CSRFToken": getCookie("csrftoken") },
        body: JSON.stringify(body),
      });

      if (!response.ok) {
        logBox.innerHTML += "‚ùå Failed to start pipeline.\n";
        return;
      }

      // ‚úÖ Ïä§Ìä∏Î¶¨Î∞ç Î°úÍ∑∏ ÏùΩÍ∏∞
      const reader = response.body.getReader();
      const decoder = new TextDecoder("utf-8");
      let buffer = "";

      let downloadAdded = false;  // ‚úÖ Ï§ëÎ≥µ Î∞©ÏßÄÏö© flag

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        const chunk = decoder.decode(value, { stream: true });
        buffer += chunk;
        logBox.innerHTML += chunk;
        logBox.scrollTop = logBox.scrollHeight;

        // ‚úÖ Îã§Ïö¥Î°úÎìú Í≤ΩÎ°ú Í∞êÏßÄ (Ìïú Î≤àÎßå Ï∂îÍ∞Ä)
        const match = buffer.match(/\[DOWNLOAD_READY\] (.+)/);
        if (match && !downloadAdded) {
          const filePath = match[1].trim();
          const fileUrl = `/download_file/?path=${encodeURIComponent(filePath)}`;
          addRow(
            "Best Architecture",
            "Ready",
            `<a href="${fileUrl}" target="_blank">Download best_structure.txt</a>`
          );
          resultTable.style.display = "table";
          downloadAdded = true; // ‚úÖ Ìïú Î≤àÎßå Ïã§ÌñâÎêòÍ≤å Ìï®
        }
      }
    };


    stopBtn.onclick = () => {
      if (isRunning) {
        stopRequested = true;
        logLine("‚õî Process stopped by user.");
      } else {
        logLine("‚ö†Ô∏è No process is currently running.");
      }
    };

    async function stageCheck(message, delay) {
      logLine(message);
      await fakeDelay(delay);
      if (stopRequested) {
        logLine("‚õî Process stopped.\n");
        isRunning = false;
        stopRequested = false;
        return true;
      }
      logLine(message.replace("Running", "Completed"));
      logLine("");
      return false;
    }

    function addRow(stage, status, pathHTML) {
      const row = document.createElement("tr");
      row.innerHTML = `<td>${stage}</td><td>${status}</td><td>${pathHTML}</td>`;
      resultBody.appendChild(row);
    }

    function logLine(text) {
      logBox.innerHTML += text + "\n";
      logBox.scrollTop = logBox.scrollHeight; // ÏûêÎèô Ïä§ÌÅ¨Î°§
    }

    function fakeDelay(ms) {
      return new Promise((resolve) => setTimeout(resolve, ms));
    }
  </script>
</body>
</html>
